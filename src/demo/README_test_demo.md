# åŸºäºtest_dataçš„äº’è¡¥å•å“æ¨èæ¼”ç¤º

è¿™æ˜¯ä¸€ä¸ªåŸºäºä½ çš„test_dataçš„äº’è¡¥å•å“æ¨èæ¼”ç¤ºç³»ç»Ÿï¼Œä½¿ç”¨Gradioæ„å»ºç”¨æˆ·ç•Œé¢ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¨ ç•Œé¢åŠŸèƒ½
- **æˆ‘çš„æ­é…**: ç”¨æˆ·å¯ä»¥æ·»åŠ ã€åˆ é™¤å’Œç®¡ç†è‡ªå·±çš„å•å“
- **å•†å“åº“æµè§ˆ**: ä»test_dataä¸­æµè§ˆå’Œé€‰æ‹©å•†å“
- **ç­›é€‰åŠŸèƒ½**: æŒ‰ç±»åˆ«å’Œåœºæ™¯ç­›é€‰å•†å“
- **åˆ†é¡µæ˜¾ç¤º**: æ”¯æŒåˆ†é¡µæµè§ˆå¤§é‡å•†å“

### ğŸ¯ æ¨èåŠŸèƒ½
- **äº’è¡¥å•å“æ¨è**: åŸºäºç”¨æˆ·é€‰æ‹©çš„å•å“æ¨èäº’è¡¥å•†å“
- **åœºæ™¯åŒ¹é…**: æ”¯æŒæŒ‰åœºæ™¯ç­›é€‰æ¨èç»“æœ

## æ–‡ä»¶ç»“æ„

```
src/demo/
â”œâ”€â”€ gradio_demo_test_data.py              # ä¸»è¦çš„Gradioæ¼”ç¤ºä»£ç 
â”œâ”€â”€ run_test_demo.py                      # è¿è¡Œè„šæœ¬
â”œâ”€â”€ run_full_demo.py                      # å®Œæ•´æµç¨‹è¿è¡Œè„šæœ¬
â”œâ”€â”€ 1_generate_rec_embeddings_test_data.py # ç”Ÿæˆæ¨èembedding
â”œâ”€â”€ 2_build_index_test_data.py            # æ„å»ºFAISSç´¢å¼•
â”œâ”€â”€ README_test_demo.md                   # æœ¬æ–‡æ¡£
â””â”€â”€ ...                                   # å…¶ä»–demoæ–‡ä»¶
```

## å®‰è£…ä¾èµ–

ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š

```bash
pip install gradio torch pillow numpy
```

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: å®Œæ•´æµç¨‹ï¼ˆæ¨èï¼‰

ä¸€é”®è¿è¡Œå®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬embeddingç”Ÿæˆã€ç´¢å¼•æ„å»ºå’ŒGradioæ¼”ç¤ºï¼š

```bash
cd src/demo
python run_full_demo.py --checkpoint /path/to/your/best_model.pth
```

### æ–¹æ³•2: åˆ†æ­¥è¿è¡Œ

#### æ­¥éª¤1: ç”Ÿæˆæ¨èembedding

```bash
cd src/demo
python 1_generate_rec_embeddings_test_data.py \
    --model_type clip \
    --test_data_dir ./src/test/test_data \
    --checkpoint /path/to/your/best_model.pth \
    --batch_size 32
```

#### æ­¥éª¤2: æ„å»ºFAISSç´¢å¼•

```bash
python 2_build_index_test_data.py \
    --test_data_dir ./src/test/test_data \
    --d_embed 512
```

#### æ­¥éª¤3: å¯åŠ¨Gradioæ¼”ç¤º

```bash
python run_test_demo.py \
    --model_type clip \
    --test_data_dir ./src/test/test_data \
    --checkpoint /path/to/your/best_model.pth \
    --port 7860 \
    --host 0.0.0.0 \
    --share
```

### æ–¹æ³•3: å¿«é€Ÿæ¼”ç¤º

ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼å¿«é€Ÿæµ‹è¯•ï¼š

```bash
python run_full_demo.py \
    --checkpoint /path/to/your/best_model.pth \
    --demo \
    --batch_size 16
```

### å‚æ•°è¯´æ˜

#### é€šç”¨å‚æ•°
- `--model_type`: æ¨¡å‹ç±»å‹ï¼Œå¯é€‰ 'original' æˆ– 'clip'ï¼Œé»˜è®¤ 'clip'
- `--test_data_dir`: æµ‹è¯•æ•°æ®ç›®å½•è·¯å¾„ï¼Œé»˜è®¤ './src/test/test_data'
- `--checkpoint`: æ¨¡å‹æ£€æŸ¥ç‚¹æ–‡ä»¶è·¯å¾„

#### Embeddingç”Ÿæˆå‚æ•°
- `--batch_size`: æ‰¹å¤„ç†å¤§å°ï¼Œé»˜è®¤ 32
- `--demo`: æ¼”ç¤ºæ¨¡å¼ï¼Œåªå¤„ç†å°‘é‡æ•°æ®

#### ç´¢å¼•æ„å»ºå‚æ•°
- `--d_embed`: embeddingç»´åº¦ï¼Œé»˜è®¤ 512
- `--faiss_type`: FAISSç´¢å¼•ç±»å‹ï¼Œé»˜è®¤ 'IndexFlatIP'

#### Gradioæ¼”ç¤ºå‚æ•°
- `--port`: æœåŠ¡å™¨ç«¯å£ï¼Œé»˜è®¤ 7860
- `--host`: æœåŠ¡å™¨ä¸»æœºåœ°å€ï¼Œé»˜è®¤ "0.0.0.0"
- `--share`: æ˜¯å¦ç”Ÿæˆå¯åˆ†äº«çš„å…¬å…±é“¾æ¥

#### å®Œæ•´æµç¨‹å‚æ•°
- `--skip_embedding`: è·³è¿‡embeddingç”Ÿæˆæ­¥éª¤
- `--skip_index`: è·³è¿‡ç´¢å¼•æ„å»ºæ­¥éª¤

## æ•°æ®è¦æ±‚

ç¡®ä¿ä½ çš„test_dataç›®å½•åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

```
src/test/test_data/
â”œâ”€â”€ result.json          # å•†å“å…ƒæ•°æ®JSONæ–‡ä»¶
â””â”€â”€ images/              # å•†å“å›¾ç‰‡ç›®å½•
    â”œâ”€â”€ 1.jpg
    â”œâ”€â”€ 2.jpg
    â”œâ”€â”€ ...
    â””â”€â”€ 199.jpg
```

è¿è¡Œåä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
src/test/test_data/
â”œâ”€â”€ result.json          # å•†å“å…ƒæ•°æ®JSONæ–‡ä»¶
â”œâ”€â”€ images/              # å•†å“å›¾ç‰‡ç›®å½•
â””â”€â”€ precomputed_rec_embeddings/  # è‡ªåŠ¨ç”Ÿæˆçš„embeddingç›®å½•
    â”œâ”€â”€ test_data_embeddings.pkl      # æ‰€æœ‰å•†å“çš„embedding
    â”œâ”€â”€ test_data_embedding_dict.pkl  # embeddingå­—å…¸
    â””â”€â”€ test_data_rec_index.faiss     # FAISSç´¢å¼•æ–‡ä»¶
```

### result.jsonæ ¼å¼

```json
[
    {
        "åç§°": "å•†å“åç§°",
        "ä¸»ç±»åˆ«": "ä¸Šè¡£",
        "å­ç±»åˆ«": "Tæ¤",
        "å“ç‰Œ": "å“ç‰Œå",
        "å‘å”®ä»·æ ¼": 299,
        "åœºæ™¯": "ä¼‘é—²",
        "é£æ ¼": "ç®€çº¦",
        "å›¾æ¡ˆ": "çº¯è‰²",
        "é€‚ç”¨å­£èŠ‚": "æ˜¥ç§‹",
        "ç‰ˆå‹": "ä¿®èº«"
    },
    ...
]
```

## ä½¿ç”¨æµç¨‹

### 1. å¯åŠ¨æ¼”ç¤º
è¿è¡Œè„šæœ¬åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€æ¼”ç¤ºé¡µé¢ï¼Œæˆ–è€…æ‰‹åŠ¨è®¿é—® `http://localhost:7860`

### 2. æ·»åŠ å•å“
- ä»å•†å“åº“ä¸­é€‰æ‹©å•†å“ï¼Œæˆ–ä¸Šä¼ è‡ªå·±çš„å›¾ç‰‡
- å¡«å†™å•†å“æè¿°å’Œç±»åˆ«
- ç‚¹å‡»"æ·»åŠ "æŒ‰é’®

### 3. è·å–æ¨è
- ç¡®ä¿å·²æ·»åŠ è‡³å°‘ä¸€ä¸ªå•å“
- å¯é€‰æ‹©å¡«å†™ç›®æ ‡æè¿°å’Œåœºæ™¯
- ç‚¹å‡»"æœç´¢æ¨è"æŒ‰é’®
- æŸ¥çœ‹æ¨èçš„äº’è¡¥å•å“

## ç•Œé¢è¯´æ˜

### ä¸»è¦åŒºåŸŸ

1. **æˆ‘çš„æ­é…**: æ˜¾ç¤ºç”¨æˆ·æ·»åŠ çš„å•å“ï¼Œæ”¯æŒé€‰æ‹©å’Œåˆ é™¤
2. **å•†å“åº“é€‰æ‹©**: æµè§ˆtest_dataä¸­çš„å•†å“ï¼Œæ”¯æŒç­›é€‰å’Œåˆ†é¡µ
3. **æ¨èåŠŸèƒ½**: äº’è¡¥å•å“æ¨è

### ç­›é€‰åŠŸèƒ½

- **æŒ‰ç±»åˆ«ç­›é€‰**: ä¸Šè¡£ã€ä¸‹è£…ç­‰
- **æŒ‰åœºæ™¯ç­›é€‰**: ä¼‘é—²ã€è¿åŠ¨ç­‰
- **åˆ†é¡µæµè§ˆ**: æ¯é¡µæ˜¾ç¤º12ä¸ªå•†å“

### æ¨èç®—æ³•

- **äº’è¡¥æ¨è**: åŸºäºembeddingç›¸ä¼¼åº¦æœç´¢äº’è¡¥å•†å“

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨**
   ```
   é”™è¯¯ï¼šæ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨
   è§£å†³ï¼šä½¿ç”¨ --checkpoint å‚æ•°æŒ‡å®šæ­£ç¡®çš„æ¨¡å‹è·¯å¾„
   ```

2. **æµ‹è¯•æ•°æ®ç›®å½•ä¸å­˜åœ¨**
   ```
   é”™è¯¯ï¼šæµ‹è¯•æ•°æ®ç›®å½•ä¸å­˜åœ¨
   è§£å†³ï¼šç¡®ä¿ test_data ç›®å½•å’Œæ–‡ä»¶ç»“æ„æ­£ç¡®
   ```

3. **ä¾èµ–åŒ…ç¼ºå¤±**
   ```
   é”™è¯¯ï¼šModuleNotFoundError
   è§£å†³ï¼špip install gradio torch pillow numpy
   ```

4. **GPUå†…å­˜ä¸è¶³**
   ```
   é”™è¯¯ï¼šCUDA out of memory
   è§£å†³ï¼šä½¿ç”¨CPUæ¨¡å¼æˆ–å‡å°‘batch size
   ```

### è°ƒè¯•æ¨¡å¼

å¯åŠ¨æ—¶æ·»åŠ  `--debug` å‚æ•°å¯ä»¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š

```bash
python run_test_demo.py --debug
```

## è‡ªå®šä¹‰ä¿®æ”¹

### ä¿®æ”¹ç•Œé¢å¸ƒå±€

ç¼–è¾‘ `gradio_demo_test_data.py` ä¸­çš„ç•Œé¢æ„å»ºéƒ¨åˆ†ï¼š

```python
with gr.Blocks(title="è‡ªå®šä¹‰æ ‡é¢˜", theme=gr.themes.Soft()) as demo:
    # ä¿®æ”¹ç•Œé¢å¸ƒå±€
    pass
```

### ä¿®æ”¹æ¨èç®—æ³•

åœ¨ `search_item` å‡½æ•°ä¸­ä¿®æ”¹æ¨èé€»è¾‘ï¼š

```python
def search_item(comp_description, comp_scene):
    # è‡ªå®šä¹‰æ¨èç®—æ³•
    pass
```

### æ·»åŠ æ–°åŠŸèƒ½

åœ¨ç•Œé¢ä¸­æ·»åŠ æ–°çš„ç»„ä»¶å’Œäº‹ä»¶å¤„ç†ï¼š

```python
# æ·»åŠ æ–°ç»„ä»¶
new_component = gr.Button("æ–°åŠŸèƒ½")

# æ·»åŠ äº‹ä»¶å¤„ç†
new_component.click(
    new_function,
    inputs=[...],
    outputs=[...]
)
```

## æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ä¼˜åŒ–

- ä½¿ç”¨ `@torch.no_grad()` è£…é¥°å™¨å‡å°‘å†…å­˜ä½¿ç”¨
- åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„å˜é‡
- ä½¿ç”¨CPUæ¨¡å¼å¦‚æœGPUå†…å­˜ä¸è¶³

### é€Ÿåº¦ä¼˜åŒ–

- é¢„è®¡ç®—å•†å“embedding
- ä½¿ç”¨å‘é‡ç´¢å¼•åŠ é€Ÿæœç´¢
- æ‰¹é‡å¤„ç†å¤šä¸ªæŸ¥è¯¢

## æ‰©å±•åŠŸèƒ½

å¯ä»¥è€ƒè™‘æ·»åŠ çš„åŠŸèƒ½ï¼š

1. **å†å²è®°å½•**: ä¿å­˜ç”¨æˆ·çš„æ­é…å†å²
2. **æ”¶è—åŠŸèƒ½**: å…è®¸ç”¨æˆ·æ”¶è—å–œæ¬¢çš„æ­é…
3. **ç¤¾äº¤åˆ†äº«**: åˆ†äº«æ­é…åˆ°ç¤¾äº¤åª’ä½“
4. **ä¸ªæ€§åŒ–æ¨è**: åŸºäºç”¨æˆ·å†å²æ¨è
5. **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒå¤šç§è¯­è¨€ç•Œé¢

## è”ç³»æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. æ¨¡å‹æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
2. æµ‹è¯•æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚
3. ä¾èµ–åŒ…æ˜¯å¦å®Œæ•´å®‰è£…
4. ç³»ç»Ÿèµ„æºæ˜¯å¦å……è¶³ 