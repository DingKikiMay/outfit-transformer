# 后端对接清单

## 🎯 对接目标

将算法库封装成API服务，供后端调用时尚单品推荐功能。

## 📋 你需要准备的内容

### 1. 模型文件

- [ ] **CIR任务最佳模型权重文件**
  - 路径：`/path/to/your/cir_best_model.pth`
  - 确认模型文件存在且可访问
  - 建议放在固定目录，如：`/root/autodl-tmp/checkpoints/`

### 2. 环境配置

- [ ] **Python环境**

  - Python 3.8+
  - 安装依赖：`pip install -r src/api/requirements.txt`
- [ ] **GPU环境**（可选）

  - CUDA 11.0+
  - 确认GPU可用：`nvidia-smi`

### 3. 服务部署

- [ ] **启动API服务**

  ```bash
  # 设置环境变量
  export MODEL_PATH=/path/to/your/cir_best_model.pth
  export MODEL_TYPE=clip
  export HOST=0.0.0.0
  export PORT=5000

  # 启动服务
  python src/api/app.py
  ```
- [ ] **验证服务状态**

  ```bash
  curl http://localhost:5000/health
  ```

## 🔧 后端需要准备的内容

### 1. 数据格式

- [ ] **用户图片**

  - 格式：JPEG/PNG
  - 编码：Base64
  - 大小：建议<5MB
- [ ] **商品数据库**

  - 必需字段：`product_id`, `title`, `category`, `image_base64`
  - 可选字段：`scene`, `description`, `price`, `brand`, `metadata`

### 2. 接口调用

- [ ] **推荐接口**
  - URL：`POST /recommend`
  - 数据格式：JSON
  - 响应处理：解析推荐结果

### 3. 错误处理

- [ ] **网络错误**

  - 连接超时
  - 服务不可用
- [ ] **业务错误**

  - 参数错误
  - 图片格式错误
  - 服务内部错误

## 📝 对接步骤

### 第一步：环境准备

1. 确认模型文件路径
2. 安装Python依赖
3. 测试GPU环境（如果有）

### 第二步：服务启动

1. 设置环境变量
2. 启动Flask服务
3. 验证服务健康状态

### 第三步：接口测试

1. 使用测试接口验证功能
2. 准备测试数据
3. 验证推荐结果

### 第四步：集成对接

1. 后端集成API调用
2. 数据格式转换
3. 错误处理机制

## 🧪 测试用例

### 测试数据准备

```json
{
  "user_images": [
    "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..."
  ],
  "product_database": [
    {
      "product_id": "test_001",
      "title": "测试商品",
      "category": "下装",
      "scene": "casual",
      "description": "测试描述",
      "image_base64": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...",
      "price": 199.0,
      "brand": "测试品牌"
    }
  ],
  "target_scene": "casual",
  "target_description": "牛仔裤",
  "target_category": "下装",
  "top_k": 5
}
```

### 测试命令

```bash
# 健康检查
curl http://localhost:5000/health

# 测试推荐
curl -X POST http://localhost:5000/test

# 实际推荐
curl -X POST http://localhost:5000/recommend \
  -H "Content-Type: application/json" \
  -d @test_data.json
```

## 📊 性能指标

### 响应时间

- 小商品库（<1000件）：1-3秒
- 中等商品库（1000-10000件）：3-5秒
- 大商品库（>10000件）：5-10秒

### 并发支持

- 建议并发数：10-50
- 内存使用：根据商品库大小调整
- GPU加速：自动启用（如果可用）

## 🚨 注意事项

### 1. 模型文件

- 确保模型文件路径正确
- 模型文件较大，注意磁盘空间
- 建议使用绝对路径

### 2. 内存管理

- 商品库越大，内存使用越多
- 建议监控内存使用情况
- 必要时分批处理

### 3. 图片处理

- 支持JPEG和PNG格式
- Base64编码，注意数据大小
- 建议压缩图片到合理大小

### 4. 错误处理

- 服务端会返回详细错误信息
- 客户端需要处理各种异常情况
- 建议实现重试机制

## 📞 对接沟通要点

### 今晚需要确认的内容

1. **模型文件路径**

   - 确认CIR最佳模型的具体路径
   - 验证模型文件是否可用
2. **数据格式**

   - 确认后端商品数据库的字段结构
   - 确认图片编码格式（Base64）
3. **接口规范**

   - 确认API接口地址和端口
   - 确认请求和响应格式
4. **部署环境**

   - 确认服务器配置（CPU/GPU/内存）
   - 确认网络访问权限
5. **测试计划**

   - 准备测试数据
   - 制定测试用例
   - 验证推荐效果

### 需要后端提供的信息

1. **商品数据库结构**

   - 字段名称和类型
   - 数据量大小
   - 更新频率
2. **用户输入格式**

   - 图片上传方式
   - 场景和描述输入
   - 推荐数量需求
3. **性能要求**

   - 响应时间要求
   - 并发量要求
   - 可用性要求
4. **部署环境**

   - 服务器配置
   - 网络环境
   - 安全要求

## ✅ 对接完成检查清单

- [ ] 模型文件加载成功
- [ ] API服务启动正常
- [ ] 健康检查接口正常
- [ ] 测试接口返回正确结果
- [ ] 后端能够成功调用推荐接口
- [ ] 推荐结果符合预期
- [ ] 错误处理机制完善
- [ ] 性能满足要求
- [ ] 文档和代码已交付

## 📚 相关文档

- [API接口文档](./API接口文档.md)
- [全库推荐使用指南](../run/README_全库推荐.md)
- [模型训练文档](../run/训练文档.md)

## 🆘 问题排查

### 常见问题

1. **模型加载失败**

   - 检查模型文件路径
   - 确认PyTorch版本兼容性
   - 检查GPU驱动
2. **服务启动失败**

   - 检查端口占用
   - 确认依赖安装完整
   - 查看错误日志
3. **推荐结果异常**

   - 检查输入数据格式
   - 确认商品库数据完整
   - 验证模型输出

### 联系方式

如有问题，请及时联系算法团队进行排查。
